---
title: "AE 05 - Sales - Reading Excel Files"
author: "Your Name"
date: "`r Sys.Date()`"
output: 
  pdf_document:
    toc: true
    latex_engine: xelatex
    keep_tex: false
  html_document:
    toc: true
    toc_float: true
    code_folding: show
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

## Introduction

In this application exercise, you'll practice reading Excel files, which often require special handling for formatting issues like merged cells, multiple sheets, and header rows.

**In this application exercise, you will:**

- Read Excel files with `read_excel()`
- Handle skip rows and column names
- Work with specific Excel sheets
- Reshape data with `pivot_longer()`
- Clean and tidy messy data

**Estimated time:** 20-30 minutes

---

## Getting Started

### Fork and Clone Workflow

**Quick reminder:** Work in YOUR forked `application-exercises` repository.

1. Navigate to the `ae-05-import-export` folder in YOUR fork
2. Open `ae-05-sales.Rmd`
3. Update the YAML with your name
4. Verify the `data-raw` folder exists with `sales.xlsx`

---

## Packages
```{r load-packages, warning=FALSE, message=FALSE}
library(tidyverse)
library(readxl)
```

**What these packages do:**

- **tidyverse:** Data wrangling and visualization
- **readxl:** Reading Excel files (.xlsx and .xls)

---

## The Challenge

Excel files are often formatted for humans to read, not for computers to analyze. Common issues include:

- Merged cells
- Multiple header rows
- Empty rows at the top
- Data spread across multiple sheets
- Inconsistent column names

**Your goal:** Read the sales data and reshape it into a tidy format.

---

## Exercise 1: Read the Excel File

First, let's look at what the raw Excel file looks like. Here's a screenshot of the target format:
```{r echo=FALSE, out.width="40%", fig.align='center'}
knitr::include_graphics("images/sales-1.png")
```

**The data shows sales by brand (rows) and year (columns).**

**Task 1.1:** Read in the Excel file from the `data-raw/` folder.

**First, explore the file:**
```{r explore-excel}
# See what sheets are in the file
excel_sheets("data-raw/sales.xlsx")

# Read with default settings to see what happens
read_excel("data-raw/sales.xlsx")
```

**Problems you might notice:**

- Empty rows at the top
- Column names might not be in the first row
- Multiple sheets (maybe?)

**Task 1.2:** Read the file correctly by skipping rows if needed.
```{r read-sales, eval = FALSE}
# Fill in the blanks
sales <- read_excel(
  "___",           # File path
  skip = ___       # Number of rows to skip (try 0, 1, 2, 3 and see what works)
)

sales
```

**Hints:**

- `skip = 3`: Skips the first 3 rows
- Try different skip values to see which gives clean column names
- The first column should be brand names

**How many rows and columns does the sales data have?**

**Your answer:** _____ rows and _____ columns

---

## Exercise 2: Understanding the Data Structure
```{r examine-sales, eval = FALSE}
# Look at the structure
glimpse(sales)

# Look at the data
sales
```

**Task 2.1:** What does each row represent?

**Your answer:**

___________________________________________________________________________

**Task 2.2:** What does each column represent?

**Your answer:**

___________________________________________________________________________

**Task 2.3:** Is this data in tidy format? Why or why not?

**Reminder - Tidy data rules:**

1. Each variable is a column
2. Each observation is a row
3. Each value is a cell

**Your answer:**

___________________________________________________________________________
___________________________________________________________________________

**Hint:** In tidy format, "year" should be a single column, not multiple columns.

---

## Exercise 3: Reshape to Tidy Format (Stretch Goal)

The goal is to reshape the data to look like this:
```{r echo=FALSE, out.width="30%", fig.align='center'}
knitr::include_graphics("images/sales-2.png")
```

**This means:**

- One column for `brand`
- One column for `year`  
- One column for `sales` (the values)

**Task 3.1:** Use `pivot_longer()` to reshape the data.
```{r reshape-sales, eval = FALSE}
# Fill in the blanks
sales_tidy <- sales %>%
  pivot_longer(
    cols = ___,                    # Which columns to pivot (all except brand)
    names_to = "___",              # Name for the new column with old column names
    values_to = "___"              # Name for the new column with values
  )

sales_tidy
```

**Hints:**

- `cols = -brand`: All columns except brand
- `names_to = "year"`: Creates a column called "year"
- `values_to = "sales"`: Creates a column called "sales"

**What `pivot_longer()` does:**

- Takes wide data and makes it long
- Column names become values in a new column
- Values from those columns go into another new column

**How many rows does the tidy data have?**
```{r count-tidy-rows, eval = FALSE}
nrow(sales_tidy)
```

**Your answer:** _____ rows

**Why does this number make sense?**

**Your answer:**

Original: _____ brands × _____ years = _____ rows in tidy format

---

## Exercise 4: Additional Data Cleaning (Stretch Goal)

**Task 4.1:** Convert the `year` column to numeric.

**Why?** After pivoting, year is stored as character (text), but it should be numeric.
```{r convert-year, eval = FALSE}
sales_tidy <- sales_tidy %>%
  mutate(year = as.numeric(___))

# Check the type
class(sales_tidy$year)
```

**Task 4.2:** Remove any rows with missing sales values.
```{r remove-na, eval = FALSE}
sales_tidy <- sales_tidy %>%
  filter(!is.na(___))

# Check how many rows remain
nrow(sales_tidy)
```

**Task 4.3:** Arrange the data by brand and year.
```{r arrange-sales, eval = FALSE}
sales_tidy <- sales_tidy %>%
  arrange(___, ___)

sales_tidy
```

---

## Exercise 5: Visualize the Data

Now that the data is tidy, we can easily create visualizations!
```{r visualize-sales, eval=FALSE}
ggplot(sales_tidy, aes(x = year, y = sales, color = brand)) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  labs(
    title = "Sales by Brand Over Time",
    x = "Year",
    y = "Sales",
    color = "Brand"
  ) +
  theme_minimal()
```

**Task 5.1:** Which brand has the highest sales in the most recent year?

**Your answer:** _____

**Task 5.2:** Which brand shows the most growth over time?

**Your answer:**

___________________________________________________________________________

---

## Exercise 6: Write Out the Tidy Data

Save the tidy data to a CSV file for future use.
```{r write-tidy-sales, eval = FALSE}
# Create data folder if needed
dir.create("data", showWarnings = FALSE)

# Write the tidy data
write_csv(___, "data/___.csv")
```

**Hint:** Use filename like `"data/sales-tidy.csv"`

---

## Exercise 7: Challenge (Optional)

**Task 7.1:** Read the sales data from a different sheet (if the Excel file has multiple sheets).
```{r read-sheet2, eval = FALSE}
# First check what sheets exist
excel_sheets("data-raw/sales.xlsx")

# Read from a specific sheet
# sales_sheet2 <- read_excel("data-raw/sales.xlsx", sheet = ___)
```

**Task 7.2:** Calculate the total sales for each brand across all years.
```{r total-sales, eval = FALSE}
sales_tidy %>%
  group_by(___) %>%
  summarise(total_sales = sum(___)) %>%
  arrange(desc(___))
```

---

## Reflection

**What was the most challenging part of reading and cleaning the Excel data?**

___________________________________________________________________________
___________________________________________________________________________

**Why is tidy data important for analysis and visualization?**

___________________________________________________________________________
___________________________________________________________________________

**What's one thing you learned about `pivot_longer()`?**

___________________________________________________________________________

---

## Knit and Submit

**Before you finish:**

1. ✅ Make sure all code chunks run without errors
2. ✅ Fill in all blanks
3. ✅ Knit to HTML first
4. ✅ If you completed stretch goals, verify the plots display correctly

**Git workflow:**

1. Stage all changed files:
   - `sales-excel.Rmd`
   - `data/sales-tidy.csv` (if you created it)
2. Click **Commit**
3. Write message: "Completed AE 05 - Sales"
4. Click **Commit** then **Push**

---

## Generate PDF for Canvas

For the full AE 05 assignment, you should submit BOTH files:

1. **Generate PDF for ae-05-nobel.Rmd:**

   - Open `ae-05-nobel.Rmd`
   - Click **Knit** dropdown → **Knit to PDF**
   - Save as `ae-05-nobel.pdf`

2. **Generate PDF for ae-05-sales.Rmd:**

   - Open `ae-05-sales.Rmd`
   - Click **Knit** dropdown → **Knit to PDF**
   - Save as `ae-05-sales.pdf`

3. **Submit BOTH PDFs to Canvas**

**Remember:** Also make sure your code is on GitHub!

---

## Troubleshooting

**Excel reading issues:**

- **Error: "file does not exist":** Check file path `data-raw/sales.xlsx`
- **Column names are weird:** Try different `skip` values
- **Extra empty columns:** Normal for Excel files - they'll be removed during cleaning
- **Can't install readxl:** Make sure you've loaded the package: `library(readxl)`

**Pivot issues:**

- **Too many/too few rows after pivot:** Check your `cols` argument
- **Column names not what you expected:** Check `names_to` and `values_to`
- **Year is character not numeric:** Use `mutate(year = as.numeric(year))`

**Visualization issues:**

- **Plot doesn't show:** Make sure data is tidy first
- **Too many lines:** Check that you completed the pivot correctly
- **Can't see all brands:** Try adjusting colors or using `facet_wrap(~brand)`

**General Excel advice:**

- Excel files are often messy - this is normal!
- Always look at the raw file first to understand its structure
- `skip` and `col_names` arguments are your friends
- When in doubt, read the help: `?read_excel`

**If you're stuck:**

- Review the walkthrough video
- Check readxl documentation: `?read_excel`, `?excel_sheets`
- Try reading the file with different `skip` values
- Ask on the discussion board

---

## Quick Reference

**Reading Excel files:**
```r
# Basic read
data <- read_excel("path/file.xlsx")

# With options
data <- read_excel("path/file.xlsx", 
                   sheet = "Sheet1",    # Specific sheet
                   skip = 3,            # Skip rows
                   col_names = TRUE)    # First row is headers
```

**Reshaping data:**
```r
# Wide to long
data_long <- data %>%
  pivot_longer(
    cols = -id_column,
    names_to = "variable",
    values_to = "value"
  )

# Long to wide
data_wide <- data %>%
  pivot_wider(
    names_from = variable_column,
    values_from = value_column
  )
```

**Useful Excel functions:**

- `excel_sheets("file.xlsx")`: List all sheets
- `read_excel(..., sheet = 2)`: Read specific sheet by number
- `read_excel(..., sheet = "Name")`: Read specific sheet by name